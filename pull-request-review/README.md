意識の高いレビュー

## はじめに
レビューが大変とかレビューしてくれる様にならないとか言う問題があって色々考えていたけど、
他のチームからも似た話が聞こえてきたのでどこも同じ様な問題を抱えているのかと思ってまとめてみます。

僕の体験をベースに書くので、的外れであったり低レベルであったりすることが多々あると思うけど、マサカリはほどほどにお願いしたいです。

## お断り
本記事ではGitHubでのコードレビューについて記載する。
そのため「レビュー」とは「GitHubでのPullRequestレビュー」とする。（以下PullRequestをPRと記載する）
（とはいえ、GitLab等でも特に変わりはなく読めるとは思う）

また、特定の言語の所謂「ありがちな落とし穴」等の話をするわけではなく、レビューという行為自体について思ったことを述べる。

## レビューについて
### PRレビューはコードレビューだけの場ではない
チームで開発をする以上そのチームの方針や考え方、プロダクトの仕様、サービスの要件、関連する外部システム、そしてタイプされたコード全ての観点の知識と経験が必要になる。
その様な観点での経験値がまとめて得られる場がレビューの場だ。

当然特定の言語のプロフェッショナルも必要だが、「何らかの要求を満たすサービス」を作り上げる以上は様々な観点が必要なはずだ。

### 個人ではなくチームに経験値をためる
しかし全てのチームメンバーが全ての知識を完璧に網羅しているなんて事はない。
だから相互にレビューをする必要がある。

レビューの結果として当然PRの質の向上は期待できるが、一番期待するべきはレビューという行為がチームの経験値として蓄積されることだと最近考えている。

### レビューのフィードバックはPR作成者ではなくチーム宛てである
PR上に現れる登場人物はどうしても「PR作成者」と「チーム内の数名」になりがちだと思う。
けど折角様々な観点で議論がされる場なのであれば、チームメンバー全員がそのフィードバックを得るべきでは無いだろうか。

例えばAさんにした指摘を別のPRでBさんにする、と言うことが無いだろうか？
当然完璧にそれを無くすことは出来ないが、「あるPRのフィードバック」が「ある特定のメンバー」にしか行かないのではなく、
フィードバックが「チーム」に行くのであれば、その様な無駄はなくせるはずだ。

そしてBさんは新たな別の指摘を受けることになるかも知れない。
それは「チームの成長」に他ならないと思う。

レビューをする側もされる側も役割に違いはなく、またどちらでもないメンバーもいない。1つのPRを使ってチームが成長する場である。それが理想的なレビューだと思う。

### レビューは添削ではなく意見交換である
レビューは正解を提示してくれる人に添削をしてもらう場ではない。

質問をしたって良いし、軽い気持ちで意見を言ったって良い。
正解コメントが出来なければレビュー側になれないなどと言う事は断じてない。

する側にしろされる側にしろ、レビューを添削だと捉えている間は個人としてもチームとしても経験値は得られない。
そしてただコードを書きその結果を矯正してもらうだけの要員の価値は低い。

## 実践
とは言え「良いレビューをしましょう」と言うだけでは行動には繋がらない。
ここからはレビューについて考える様になったここ半年ほどで決めてみた具体アクションを提示してみたい。

どれも特に難しいことではないので、試すのは簡単なはずだ。

### PullRequestを出すとき
まずRP作成者は「レビューにはコストがかかる」と言う認識を持つと良いと思う。
そして無駄な指摘を省き気分良く効率的にレビューが出来る様にすることを意識する。

また、PRは「残る」という事も気にしてみると良い。

#### 適切な概要欄を書く
以下の様なPRがないだろうか？

```Markdown
通信制限の実装

どんな状態で制限するべきかは整理が必要
```

こんな概要欄で一体どんなレビューが出来る？
理解ある数名の間では通じるのかも知れないが、先に書いた通りレビューは「チームへのフィードバックの場」だ。
このPRに関する仕様やスキルの足らない者もレビューに参加できる様にする義務がPR作成者にはある。

概要欄をある程度ちゃんと書いてもらうのは簡単で、GitHubテンプレートを用いれば良い。
特定のファイル名でMarkdownをpushしておくと、PR作成時にそのMarkdownを用いてPRの概要欄を書くことが出来る仕組みだ。

これについては[過去にQiitaに投稿した](http://qiita.com/suzuki-hoge/items/3a568dff36fd981082ba#git-template-for-pull-request-pullrequest%E4%BD%9C%E6%88%90%E6%99%82%E3%81%AE%E8%AA%AC%E6%98%8E%E6%AC%84%E3%81%AB%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B)ことがあるので、そちらも見てもらいたい。

今チームで運用しているPRテンプレートは以下の様になった。

```Markdown
## 目的

## 関連するIssue等
+ 

## レビューポイント
### サービス仕様観点
+ 

### 外部結合観点
+ 

### 実装観点
+ 

### テスト観点
+ 

## 留意事項
+ 

## 残課題
+ 
```

コーディング界隈で「未来の自分は他人、適当に書いてもまず忘れる」なんて話があるが、PRの概要欄も同じ事だと思う。
PRは残るのだ。手間をかけすぎる必要は無いが、ある程度は丁寧に作るべきだ。

#### 適切なコミットにする
PR概要欄に続き、次は以下の様なコミットについてだ。

```
半分適用                         92df81
動いた                           196043
指摘１                           cbd97e
指摘２                           6ee542
削除漏れ                         9a8b5e
```

まず問題は「コミットも残る」点だ。
HistoryやBlameを見るとき、featureをdevelopにマージするとき、色んなタイミングで過去のコミットを見ることがある。
その際にこれでは何もわからない。

次に「このコミットを積み重ねるとどうなるのかわからない」点だ。
テストはあるのか？外部結合は済んでいるのか？改版するべきドキュメントは？
ふと目に入るコミット履歴からその様な事がわかるだけでもレビューのコストも変わってくるはずだ。

最後に、「無礼」だ。
緊急パッチならともかく、常時この様なコミットをしてあまつさえ早くお願いしますなどと言うのは無礼極まりない。

ではどうするかと言うと、なによりもまず適切なメッセージを書くことだ。
具体的には調べると沢山記事がヒットするので割愛するが、チームでルールを決めておくのも良い。

また適切な単位にするためには「コミットをまとめる技」を知っておく必要がある。

どうしてもブランチを切り換えなければならない場合や改修範囲が広すぎる場合等は以下を行うと良い

+ `git stash`を使い待避する
+ 適当なメッセージでコミットをし、最後に`git rebase -i`でまとめる
+ 作りたいコミットが出来たつもりでメッセージを書きコミットをし、後に続きのコミットを`git commit --ammend --no-edit`でそのコミットに追記する

その様にして適切にしたコミットに適当なメッセージを書く
メッセージは「このコミットが何を実現するか」の様な観点で書くと良い。

前半2つと後半3つをそれぞれまとめてメッセージを書いてみると、例えばこの様になる。

```
商品購入時に課金を行う           8342ba
キャンペーン時の値引き漏れを修正 8bad12
```

#### 本質と関係ない修正や多量の差分を含まない
多数のファイルのパッケージ移動やリネーム等は独立した別のPRで行うべきだ。
最近は「仕様を満たすためのPR」と「それ以外」は分けて小さく出す様にしている。

本流のPRのレビューが長丁場になった場合に、PRの差分が多いと大抵衝突で泣きを見るし、
他のPRで「そのリファクタ早くマージして欲しい」などと言った状況が往々にして生まれるからだ。

また本質と関係ない差分が多くなってしまうとレビューの質も当然下がってしまう。

#### アサインをしない
GitHubの機能である以上有用な使い道はあるのだろうが、僕はチームに「PRは誰かにアサインしないこと」を提案して受け入れてもらっている。

多様な観点全てを特定の人が満たしていることはないだろうし、レビューする側にも得られる経験値はあるはずなのだ。

属人化を防ぎPRをチームの物とするために、特定の個人を指定することはしない様にしてみた。

### PullRequestを出したら
#### まず自分でPRを見る
最初に、PRを作った直後のことだ。
PRを作った直後はまず自分でそのPRを見ると良いと感じていて、実際に僕はそうしている。

ここで見るべきは上記に上げた様な観点だ、つまり「概要欄」「コミット」「過度な差分」そして「意図しない差分」についてだ。
他に「コーディング規約」や「フォーマット規約」を遵守しているかも確認する。

その様な指摘は冒頭で述べたチームへのフィードバックとしては正直に言ってくだらないし、指摘してくれる人に対して無礼だ。
添削から意見交換にするためにも、上記の様な観点を自分で潰すことはとても大切だ。

また（後述するが）、レビューをすること自体の練習にもなる。
自分のPRを満足に見ない者がどうして他者のPRのレビューが出来ようか。

#### そのPRにおけるファシリテータは自分
「どっちが良いですかね」の様な流れになることは多々あるが、みんな言うだけ言ってオチが付かないと言う事も多々あるだろう。
その様な場合には議論を仕切ってオチまで持って行く責任はPR作成者にあると思う。

議論参加者だけにそれを求めてはいけないし、ファシリテータ == エキスパートでもないと思う。
全員参加型の意見交換の場ではあれど、ファシリテータは必要なのだ。
それを放棄すると言う事は個人の成長にならず、チームの成長に繋がらない。
逆に言うとそれをしない場合は結局は本質は添削待ちなのだ。

PRを作るまでではなく、PRをマージまで持って行くのがPR作成者の責任だ。

#### 他者のレビューをする
レビューをしてもらう以上、自分もレビューをしなければならない。
この考えはどちらかと言うと「礼儀」に由来する気がする。

さっそく次の実装にとりかかりたいコーディング大好きという気持ちもとてもわかるが、まずは気持ちを切り換えてレビューをしよう。

### PullRequestを見るとき
#### 差分を見る
僕はPRは手元に持ってきて、複数のモニターを使って差分（ブラウザ）とエディタを並べて見ることが多い。

「まぁそこに書くよね」みたいな増分より、「あれ？何この増分？」みたいな箇所をブラウザでざざーっと探して、手元のエディタで前後を読むことが多い気がする。

差分が多い（行数と言うよりはファイル数）場合はそのPRの肝になりそうなファイルいくつかに当たりを付けて、そこの前後をエディタで読んだりする。

この当たりを付けるのはそのチームでの経験や慣れが必要だが、時間がかかっても、全差分読まなければわからなくても、頑張ってやるべきだと思う。
差分の中からレビュー箇所に当たりを付けるという作業は訓練しないと出来ないことだと思う。

#### 要件を満たすか考える
修正漏れは差分に現れないので、次に「概要欄で言っている〜〜を実現するにはこのPRで十分か」という観点で全体をざっと見る。

ここは差分として存在しない領域について考えなければならないので難易度が高い。
そもそもの仕様からDB設計や外部システムまでを通して知らなければならないので、一朝一夕では身につかないスキルだと思う。

後述

また、テストを見るのが良い場合もある。

#### コードを見る
単純なコーディング言語のレビュー等も行う。

この観点はどちらかというと局所最適の話で、差分を上から眺めて気になったコードに気楽にコメントをするだけで十分で、他の特別な訓練はいらない。
ある意味では、一番ハードルの低い観点ではないかと思うので、まずはここからレビューになれるのも良いと思う。

#### テストを見る
自動テストを書いているチームの場合、PR内に対応する自動テストを含んでいることが望ましい。
マージした後でテストを書いてみたら問題があったでは残念ではないか。

テストに関しては主に「テストパターンが適切か」、「テストデータは正しいか」の観点で見る。

他には「テストコードが冗長すぎたり、重複が多くないか」も僕は気にしている。
そうである場合、テストを書くのが面倒になったり修正コストがテストまわりで増大したりでテストコードを書くのが嫌になってしまうからだ。

手間はかけずに適切に網羅出来るテストかを気にすると良い。

#### 他人のしたコメントを見る
人によって結構指摘する箇所は違うので、他人のコメントも参考になる。

「そういうパターンがあるのか」なんて思ったらさも自分が気付いた様に他のPRで指摘すれば良い。
「これって〜〜のパターン大丈夫なんでしたっけ？」なんて軽さで十分だ。言うのはノーコスト、どんどん思いつきを言えば良い。
それでみんなが指摘する様に伝染し始めたら、それはもうチームの成長だ。いずれはそんなの当然のレベルに達してそんな指摘は出なくなる。

#### 見ない点
テストが通るのか、衝突はないのかと言った観点は例えば[Jenkins PullRequest Builder](http://qiita.com/suzuki-hoge/items/159bfbcb883a9ce74157#jenkins-github-pull-request-builder-pullrequest%E3%81%8C%E3%83%9E%E3%83%BC%E3%82%B8%E3%81%95%E3%82%8C%E3%82%8B%E9%9A%9B%E3%81%ABjenkins%E3%81%A7%E3%83%93%E3%83%AB%E3%83%89%E3%81%99%E3%82%8B)でも使って自動化しよう。

そんなことを労力を使って確認することはない。

### PullRequestについていけない場合

### ついて行けないとき
誰よりも早くコメントする
答え合わせの場ではない

あとで付いたコメントを見る

#### 業務知識が足りない場合

#### スキルが足りない場合

#### コメント出来ない場合

長いとコンフリクトが

レビューで全体像を知る
いきなりPRレビューは出来ない
なんかで見たな

色んな事は棚に上げて偉そうに書いてみたーﾊｽﾞｶｼｰ
